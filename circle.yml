machine:
  environment:
    NIPYPE_NPROCS: 4
    ANTS_NTHREADS: 4
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - "~/data"

  pre:
    # Download test data
    - mkdir -p ~/data/ ~/docker ~/scratch/func ~/scratch/anat
    - if [[ ! -d ~/data/ds003_downsampled ]]; then wget --retry-connrefused --waitretry=5 --read-timeout=20 --timeout=15 -t 0 -q https://3552243d5be815c1b09152da6525cb8fe7b900a6.googledrive.com/host/0BxI12kyv2olZVUswazA3NkFvOXM/ds003_downsampled.tar.gz && tar xzf ds003_downsampled.tar.gz -C ~/data/; fi
    # - pip install coverage
  override:
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -f docker/Dockerfile_py35 -t mriqc:py35 .
    - docker build -f docker/Dockerfile_py27 -t mriqc:py27 .
    - docker save mriqc:py35 > ~/docker/image.tar

test:
  override:
    # Test mriqcp
    - docker run -i -v /etc/localtime:/etc/localtime:ro -w /root/src/mriqc --entrypoint="/usr/bin/run_tests" mriqc:py35
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/data:/data:ro -v ~/scratch:/scratch -w /scratch/func mriqc:py27 /data/ds003_downsampled out/ participant -d func -w work/ --nthreads ${NIPYPE_NPROCS} --testing
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/data:/data:ro -v ~/scratch:/scratch -w /scratch/func mriqc:py35 /data/ds003_downsampled out/ group -d func -w work/
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/data:/data:ro -v ~/scratch:/scratch -w /scratch/anat mriqc:py35 /data/ds003_downsampled out/ participant -d anat -w work/ --nthreads ${NIPYPE_NPROCS} --testing --ants-nthreads ${ANTS_NTHREADS}:
        timeout: 2600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/data:/data:ro -v ~/scratch:/scratch -w /scratch/anat mriqc:py27 /data/ds003_downsampled out/ group -d anat -w work/

general:
  artifacts:
    - "~/scratch/func/out"
    - "~/scratch/func/work"
    - "~/scratch/anat/out"
    - "~/scratch/anat/work"

# deployment:
#   codecov:
#     branch: /.*/
#     commands:
#       - bash <(curl -s https://codecov.io/bash)
