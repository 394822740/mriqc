dependencies:
  cache_directories:
    - "~/examples/"
    - "~/.apt-cache"
    - "~/.apt-lists"
    - "~/workdir"
  pre:
    # Let CircleCI cache the apt archive
    - sudo rm -rf /var/cache/apt/archives && sudo ln -s ~/.apt-cache/archives /var/cache/apt/archives && mkdir -p ~/.apt-cache/archives/partial
    - sudo rm -rf /var/cache/apt/pkgcache.bin && sudo ln -s ~/.apt-cache/pkgcache.bin /var/cache/apt/pkgcache.bin && touch ~/.apt-cache/pkgcache.bin
    - sudo rm -rf /var/cache/apt/srcpkgcache.bin && sudo ln -s ~/.apt-cache/srcpkgcache.bin /var/cache/apt/srcpkgcache.bin && touch ~/.apt-cache/srcpkgcache.bin
    - sudo rm -rf /var/lib/apt/lists && sudo ln -s ~/.apt-lists /var/lib/apt/lists
    - wget -O- http://neuro.debian.net/lists/precise.us-ca.full | sudo tee /etc/apt/sources.list.d/neurodebian.sources.list
    - sudo apt-key adv --recv-keys --keyserver hkp://pgp.mit.edu:80 0xA5D32F012649A5A9
    - sudo apt-get update
    - bash ./circle_setup.sh
  override:
    - sudo apt-get install -y fsl-core fsl-atlases fsl-mni152-templates afni ants
    - echo "source /etc/fsl/fsl.sh" >> $HOME/.profile
    - echo "source /etc/afni/afni.sh" >> $HOME/.profile
    - pip install --upgrade pip
    - pip install numpy
    - pip install -r requirements.txt
    - pip install -e .
machine:
  environment:
    FSLOUTPUTTYPE: NIFTI_GZ
test:
  override:
    # Test mriqcp
    - source $HOME/.profile; python scripts/mriqcp.py -i ~/examples/ds003_sub-01/ -o ~/outdir/single-subject -w ~/workdir/single-subject
    - source $HOME/.profile; python scripts/mriqcp.py -i ~/examples/ds003_downsampled/ -o ~/outdir/multiple-subject-func -w ~/workdir/multiple-subject-func --skip-anatomical  --use-plugin ~/examples/plugin.yml
    - source $HOME/.profile; python scripts/mriqcp.py -i ~/examples/ds003_downsampled/ -o ~/outdir/multiple-subject-anat -w ~/workdir/multiple-subject-anat --skip-functional
general:
  artifacts:
    - "~/outdir/single-subject"
    - "~/workdir/single-subject"
    - "~/outdir/multiple-subject-func"
    - "~/workdir/multiple-subject-func"
    - "~/outdir/multiple-subject-anat"
    - "~/workdir/multiple-subject-anat"